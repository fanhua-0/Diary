<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æˆ‘çš„äº‘ç«¯æ—¥è®°æœ¬</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />
    <script src="https://unpkg.com/element-plus"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/@element-plus/icons-vue"></script>

    <style>
        /* å…¨å±€èƒŒæ™¯ï¼šæç‚¹æ¸å˜è‰²ï¼Œä¸å†æ­»æ¿ */
        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .nav-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            padding: 20px 30px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        }

        .app-title {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* å¡ç‰‡å®¹å™¨å¸ƒå±€ */
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
        }

        /* æ—¥è®°å¡ç‰‡æ ·å¼ */
        .diary-card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            transition: all 0.3s ease;
            position: relative;
            border: 1px solid rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            height: 280px; /* å›ºå®šé«˜åº¦ï¼Œæ•´é½ä¸€ç‚¹ */
        }

        .diary-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
            border-color: #a1c4fd;
        }

        .card-date {
            font-size: 13px;
            color: #909399;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .card-title {
            font-size: 18px;
            font-weight: bold;
            color: #303133;
            margin-bottom: 15px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .card-content {
            font-size: 14px;
            color: #606266;
            line-height: 1.6;
            flex-grow: 1; /* è®©å†…å®¹å æ®å‰©ä½™ç©ºé—´ */
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 5; /* æœ€å¤šæ˜¾ç¤º5è¡Œ */
            -webkit-box-orient: vertical;
            margin-bottom: 15px;
        }

        /* åº•éƒ¨æ“ä½œåŒº */
        .card-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            opacity: 0; /* é»˜è®¤éšè—æŒ‰é’® */
            transition: opacity 0.3s;
        }

        .diary-card:hover .card-actions {
            opacity: 1; /* é¼ æ ‡æ”¾ä¸Šå»æ‰æ˜¾ç¤ºæŒ‰é’® */
        }

        /* åŠ è½½åŠ¨ç”»ä¿®æ­£ */
        .loading-container {
            text-align: center;
            padding: 50px;
            color: #909399;
        }
    </style>
</head>
<body>
<div id="app">
    <div class="main-container">
        <!-- é¡¶éƒ¨æ  -->
        <div class="nav-header">
            <div class="app-title">
                <span>ğŸ“–</span>
                <span>ç§å¯†æ—¥è®°æœ¬</span>
            </div>
            <el-button type="primary" size="large" round color="#626aef" @click="openAddDialog">
                <el-icon class="el-icon--left"><Edit /></el-icon>
                å†™ä¸€ç¯‡æ–°çš„
            </el-button>
        </div>

        <!-- åŠ è½½ä¸­ -->
        <div v-if="loading" class="loading-container">
            æ‹¼å‘½åŠ è½½ä¸­...
        </div>

        <!-- ç©ºçŠ¶æ€ -->
        <el-empty v-if="!loading && diaryList.length === 0" description="è¿™é‡Œç©ºç©ºå¦‚ä¹Ÿï¼Œå¿«å»å†™ä¸‹ç¬¬ä¸€ç¯‡æ—¥è®°å§ï¼"></el-empty>

        <!-- æ—¥è®°å¡ç‰‡åˆ—è¡¨ -->
        <div class="card-grid" v-if="!loading && diaryList.length > 0">
            <div class="diary-card" v-for="item in diaryList" :key="item.id" @click="showDetail(item)">
                <div class="card-date">
                    <el-icon><Calendar /></el-icon>
                    {{ formatTime(item.createTime) }}
                </div>
                <div class="card-title">{{ item.title }}</div>
                <div class="card-content">{{ item.content }}</div>

                <div class="card-actions" @click.stop> <!-- stopé˜²æ­¢ç‚¹æŒ‰é’®æ—¶è§¦å‘æŸ¥çœ‹è¯¦æƒ… -->
                    <el-button type="primary" circle size="small" @click="openEditDialog(item)">
                        <el-icon><Edit-Pen /></el-icon>
                    </el-button>
                    <el-button type="danger" circle size="small" @click="handleDelete(item.id)">
                        <el-icon><Delete /></el-icon>
                    </el-button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘/æ–°å¢ å¼¹çª— (åŠ å¤§åŠ å®½ç‰ˆ) -->
    <el-dialog
            v-model="dialogVisible"
            :title="isEditMode ? 'âœï¸ ç¼–è¾‘æˆ‘çš„å›å¿†' : 'ğŸ“ å†™ä¸€ç¯‡æ–°æ—¥è®°'"
            width="75%"
            top="5vh"
            style="border-radius: 16px; max-width: 1000px;">

        <el-form :model="form" label-position="top">
            <el-form-item label="æ ‡é¢˜">
                <el-input
                        v-model="form.title"
                        placeholder="ç»™ä»Šå¤©èµ·ä¸ªæ ‡é¢˜å§..."
                        size="large"
                        style="font-size: 18px; font-weight: bold;">
                </el-input>
            </el-form-item>

            <el-form-item label="æ­£æ–‡">
                <el-input
                        v-model="form.content"
                        type="textarea"
                        :rows="18"
                        placeholder="åœ¨è¿™é‡Œå°½æƒ…ä¹¦å†™..."
                        resize="none"
                        style="font-size: 16px; line-height: 1.6;">
                </el-input>
            </el-form-item>
        </el-form>

        <template #footer>
                <span class="dialog-footer">
                    <el-button @click="dialogVisible = false" size="large" round>å…ˆä¸å†™äº†</el-button>
                    <el-button type="primary" @click="submitDiary" size="large" round color="#626aef" style="padding: 0 40px;">
                        ä¿å­˜æ—¥è®°
                    </el-button>
                </span>
        </template>
    </el-dialog>

    <!-- æŸ¥çœ‹è¯¦æƒ…å¼¹çª— -->
    <el-dialog v-model="detailVisible" :title="currentDiary.title" width="600px" center>
        <div style="text-align: center; color: #999; margin-bottom: 20px;">
            {{ formatTime(currentDiary.createTime) }}
        </div>
        <div style="font-size: 16px; line-height: 1.8; color: #333; white-space: pre-wrap; padding: 0 20px;">
            {{ currentDiary.content }}
        </div>
    </el-dialog>
</div>

<script>
    const { createApp, ref, reactive, onMounted } = Vue;
    const { ElMessage, ElMessageBox } = ElementPlus;
    const { Edit, Calendar, Delete, EditPen } = ElementPlusIconsVue;

    const app = createApp({
        components: { Edit, Calendar, Delete, EditPen },
        setup() {
            // åç«¯åœ°å€
            const API_BASE_URL = 'http://localhost:8080/diary';

            const diaryList = ref([]);
            const loading = ref(false);
            const dialogVisible = ref(false);
            const detailVisible = ref(false);
            const isEditMode = ref(false); // æ ‡è®°æ˜¯â€œæ–°å¢â€è¿˜æ˜¯â€œä¿®æ”¹â€

            const form = reactive({
                id: null,
                title: '',
                content: ''
            });

            const currentDiary = ref({});

            // 1. è·å–åˆ—è¡¨
            const getList = () => {
                loading.value = true;
                // æ³¨æ„ï¼šè¿™é‡Œç”¨çš„æ˜¯ä½ å®šä¹‰çš„ /getAll æ¥å£
                axios.get(API_BASE_URL + '/getAll')
                    .then(res => {
                        if(res.data.code === 200) {
                            // å€’åºæ’åˆ—ï¼Œæœ€æ–°çš„åœ¨å‰é¢
                            diaryList.value = res.data.data.reverse();
                        } else {
                            ElMessage.error('è·å–å¤±è´¥');
                        }
                    })
                    .finally(() => loading.value = false);
            };

            // 2. æ‰“å¼€æ–°å¢çª—å£
            const openAddDialog = () => {
                isEditMode.value = false;
                form.id = null;
                form.title = '';
                form.content = '';
                dialogVisible.value = true;
            };

            // 3. æ‰“å¼€ä¿®æ”¹çª—å£ (å…³é”®åŠŸèƒ½)
            const openEditDialog = (item) => {
                isEditMode.value = true;
                // å›æ˜¾æ•°æ®
                form.id = item.id;
                form.title = item.title;
                form.content = item.content;
                dialogVisible.value = true;
            };

            // 4. æäº¤ï¼ˆæ ¹æ®æ¨¡å¼åˆ¤æ–­æ˜¯æ–°å¢è¿˜æ˜¯ä¿®æ”¹ï¼‰
            const submitDiary = () => {
                if(!form.title || !form.content) {
                    ElMessage.warning('å†™ç‚¹ä¸œè¥¿å†ä¿å­˜å§~');
                    return;
                }

                if (isEditMode.value) {
                    // --- ä¿®æ”¹é€»è¾‘ ---
                    axios.post(API_BASE_URL + '/update', form)
                        .then(res => {
                            if(res.data.code === 200) {
                                ElMessage.success('ä¿®æ”¹æˆåŠŸ âœ¨');
                                dialogVisible.value = false;
                                getList();
                            } else {
                                ElMessage.error(res.data.message);
                            }
                        });
                } else {
                    // --- æ–°å¢é€»è¾‘ ---
                    axios.post(API_BASE_URL + '/add', form)
                        .then(res => {
                            if(res.data.code === 200) {
                                ElMessage.success('å‘å¸ƒæˆåŠŸ ğŸ‰');
                                dialogVisible.value = false;
                                getList();
                            } else {
                                ElMessage.error(res.data.message);
                            }
                        });
                }
            };

            // 5. åˆ é™¤
            const handleDelete = (id) => {
                ElMessageBox.confirm('çœŸçš„è¦ç‹ å¿ƒåˆ é™¤è¿™ç¯‡å›å¿†å—ï¼Ÿ', 'æç¤º', {
                    confirmButtonText: 'åˆ æ‰',
                    cancelButtonText: 'ç•™ç€',
                    type: 'warning'
                }).then(() => {
                    axios.post(API_BASE_URL + '/delete?id=' + id)
                        .then(res => {
                            if(res.data.code === 200) {
                                ElMessage.success('å·²åˆ é™¤');
                                getList();
                            }
                        });
                }).catch(() => {});
            };

            const showDetail = (item) => {
                currentDiary.value = item;
                detailVisible.value = true;
            };

            const formatTime = (str) => {
                if(!str) return '';
                return str.replace('T', ' ').substring(0, 16);
            };

            onMounted(() => {
                getList();
            });

            return {
                diaryList, loading, dialogVisible, detailVisible,
                form, currentDiary, isEditMode,
                openAddDialog, openEditDialog, submitDiary, handleDelete, showDetail, formatTime
            };
        }
    });

    app.use(ElementPlus);
    app.mount('#app');
</script>
</body>
</html>
